---
title: "AWS CDKå…¬å¼ãƒãƒ¥ãƒ¼ãƒˆãƒªã‚¢ãƒ«å®Ÿæ³ãƒ—ãƒ¬ã‚¤"
emoji: "ğŸ“˜"
type: "tech" # tech: æŠ€è¡“è¨˜äº‹ / idea: ã‚¢ã‚¤ãƒ‡ã‚¢
topics: []
published: true
---

AWS CDKã«èˆˆå‘³ãŒã‚ã£ãŸã®ã§å…¬å¼ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã‚’è¦‹ãªãŒã‚‰é€²ã‚ã¦è¦‹ã‚‹ã€‚
å…¬å¼ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã«æ—¥æœ¬èªãŒãªã„ã®ãŒã¡ã‚‡ã£ã¨è¾›ã„ãŒã€‚ã€‚ã€‚

## å…¬å¼ãƒãƒ¥ãƒ¼ãƒˆãƒªã‚¢ãƒ«

Clod9ã«AWS CDKã‚’å°å…¥ã™ã‚‹å…¬å¼ãƒãƒ¥ãƒ¼ãƒˆãƒªã‚¢ãƒ«ãŒã‚ã£ãŸã®ã§ã¾ãšã¯ãã¡ã‚‰ã‚’é€²ã‚ã‚‹ã€‚

### AWS CDK CLIã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«

ã¾ãšã¯npmçµŒç”±ã§cliã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã—ã¦ã¿ã‚‹

```
npm install -g aws-cdk
```

â†“ã®ã‚ˆã†ãªãƒ­ã‚°ãŒæµã‚Œã¦ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«å®Œäº†

```
added 2 packages, and audited 3 packages in 4s

found 0 vulnerabilities
npm notice 
npm notice New minor version of npm available! 8.5.0 -> 8.19.2
npm notice Changelog: https://github.com/npm/cli/releases/tag/v8.19.2
npm notice Run npm install -g npm@8.19.2 to update!
npm notice 
```

â†“ã®ã‚³ãƒãƒ³ãƒ‰ã§ãƒãƒ¼ã‚¸ãƒ§ãƒ³ãŒè¡¨ç¤ºã•ã‚Œã¦ã„ã‚Œã°ãŠk

```
cdk --version 
2.47.0 (build 3528e3d)
```

### AWS CDK CLIã«AWSã‚¢ã‚«ã‚¦ãƒ³ãƒˆã‚’ç´ä»˜ã‘

å…¬å¼ã§ã¯ã€Œãƒ–ãƒ¼ãƒˆã‚¹ãƒˆãƒ©ãƒƒãƒ—ã€ã£ã¦è¡¨ç¾ãŒä½¿ã‚ã‚Œã¦ã„ã‚‹ã‘ã©ã¾ãç´ä»˜ã‘ã£ã¦ã“ã¨ã ã¨æ€ã†ã€‚

ä»¥ä¸‹ã®ã‚³ãƒãƒ³ãƒ‰ã§aws cliã«ç´ã¥ã„ã¦ã„ã‚‹èªè¨¼æƒ…å ±ã‚’å–å¾—ã€‚
ãŠãã‚‰ã `~/.aws/credentials` ã®defaultã£ã¦åå‰ã®ã¤ã„ãŸãƒ—ãƒ­ãƒ•ã‚¡ã‚¤ãƒ«ãŒä½¿ã‚ã‚Œã¦ã„ãã†

```
aws sts get-caller-identity
```

å®Ÿè¡Œçµæœ

```
{
    "UserId": "xxxxxxxxxxxxx",
    "Account": "nnnnnnnnnnnn",
    "Arn": "arn:aws:iam::nnnnnnnnnnn:user/yyyyyyyy"
}
```

ã‚“ã§â†“ã‚’å®Ÿè¡Œã™ã‚‹ã¨ç´ä»˜ã‘ã§ãã‚‹

```
cdk bootstrap aws://ACCOUNT-NUMBER/REGION
```

å®Ÿè¡Œçµæœ

```
â³  Bootstrapping environment aws://nnnnnnnnnnnn/ap-northeast-1...
Trusted accounts for deployment: (none)
Trusted accounts for lookup: (none)
Using default execution policy of 'arn:aws:iam::aws:policy/AdministratorAccess'. Pass '--cloudformation-execution-policies' to customize.
CDKToolkit: creating CloudFormation changeset...
 âœ…  Environment aws://nnnnnnnnnn/ap-northeast-1 bootstrapped.
```

ãŠãã‚‰ãã“ã‚Œã§ã€Œã“ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’ä½¿ã£ã¦ã“ã®ãƒªãƒ¼ã‚¸ãƒ§ãƒ³ã«ãƒªã‚½ãƒ¼ã‚¹ã‚’ç«‹ã¦ã‚‰ã‚Œã‚‹ã‚ˆã†ã«ã—ãŸã‚ˆã€ã£ã¦ã®ãŒè¨­å®šã§ããŸã®ã‹ãªã¨æ€ã†

### AWS CDKãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã®é–‹å§‹

cdk cliã®æº–å‚™ãŒæ•´ã£ãŸã®ã§æ—©é€Ÿãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã‚’ä½œã‚‹

```
mkdir cdk-demo
cd cdk-demo
cdk init --language typescript
```

languageã®ã¨ã“ã‚ã«ã¯CDKã§åˆ©ç”¨ã§ãã‚‹è¨€èªãŒä½¿ãˆã‚‹ã€‚ä¸€è¦§ã¯â†“ã«è¼‰ã£ã¦ã„ã‚‹ã€‚ä»Šå›ã¯Typescriptã‚’ä½¿ã†
https://docs.aws.amazon.com/ja_jp/cdk/v2/guide/getting_started.html

â†“ã¿ãŸã„ãªæ„Ÿã˜ã®ãƒ­ã‚°ãŒæµã‚Œã‚‹

```
Applying project template app for typescript
# Welcome to your CDK TypeScript project

This is a blank project for CDK development with TypeScript.

The `cdk.json` file tells the CDK Toolkit how to execute your app.

## Useful commands

* `npm run build`   compile typescript to js
* `npm run watch`   watch for changes and compile
* `npm run test`    perform the jest unit tests
* `cdk deploy`      deploy this stack to your default AWS account/region
* `cdk diff`        compare deployed stack with current state
* `cdk synth`       emits the synthesized CloudFormation template

Initializing a new git repository...
hint: Using 'master' as the name for the initial branch. This default branch name
hint: is subject to change. To configure the initial branch name to use in all
hint: of your new repositories, which will suppress this warning, call:
hint: 
hint: 	git config --global init.defaultBranch <name>
hint: 
hint: Names commonly chosen instead of 'master' are 'main', 'trunk' and
hint: 'development'. The just-created branch can be renamed via this command:
hint: 
hint: 	git branch -m <name>
bin/cdk-demo.ts:18:  // env: { account: '123456789012', region: 'us-east-1' },

[ERROR] Matched one or more prohibited patterns

Possible mitigations:
- Mark false positives as allowed using: git config --add secrets.allowed ...
- Mark false positives as allowed by adding regular expressions to .gitallowed at repository's root directory
- List your configured patterns: git config --get-all secrets.patterns
- List your configured allowed patterns: git config --get-all secrets.allowed
- List your configured allowed patterns in .gitallowed at repository's root directory
- Use --no-verify if this is a one-time false positive
Unable to initialize git repository for your project.
Executing npm install...
npm WARN deprecated w3c-hr-time@1.0.2: Use your platform's native performance.now() and performance.timeOrigin.
âœ… All done!
```

åˆæœŸãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã«ã¯ã‚µãƒ³ãƒ—ãƒ«ã®stackãŒã™ã§ã«å…¥ã£ã¦ã„ã‚‹

å„ç¨®ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªãƒ»ãƒ•ã‚¡ã‚¤ãƒ«ã®æ„å‘³

- bin...å®Ÿéš›ã«AWSã«ãƒªã‚½ãƒ¼ã‚¹ã‚’ä½œã‚‹éš›ã®èµ·ç‚¹ã«ãªã‚‹ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒª
- lib...binãƒ•ã‚¡ã‚¤ãƒ«ã®ä¸­èº«ã‚’æ±ºã‚ã‚‹ã€‚åŸºæœ¬ã¯ã“ã“ã‚’ç·¨é›†ã™ã‚‹
- test...ãƒ†ã‚¹ãƒˆã‚’ã‹ã‘ã‚‹ã€‚ã‚µãƒ³ãƒ—ãƒ«ã‚³ãƒ¼ãƒ‰ã‚’è¦‹ã‚‹é™ã‚Šã¯ãƒªã‚½ãƒ¼ã‚¹ã®ä½œæˆã‚„ãƒ—ãƒ­ãƒ‘ãƒ†ã‚£ã®ãƒã‚§ãƒƒã‚¯ãŒã§ãããŠã†
- cdk.json...CDKå…¨ä½“ã®è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ã«ã‚ãŸã‚‹json

### binãƒ•ã‚¡ã‚¤ãƒ«ã«ã‚¢ã‚«ã‚¦ãƒ³ãƒˆæƒ…å ±ã‚’è¨­å®š

ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã§ã¯ãƒ­ãƒ¼ã‚«ãƒ«cliã«è¨­å®šã—ãŸã‚¢ã‚«ã‚¦ãƒ³ãƒˆã¨ãƒªãƒ¼ã‚¸ãƒ§ãƒ³ãŒä½¿ã‚ã‚Œã‚‹ãŒ
ã‚³ãƒ¡ãƒ³ãƒˆã‚¢ã‚¦ãƒˆã‚’å¤–ã—ã¦ã‚³ãƒ¼ãƒ‰ä¸Šã«è¨˜è¼‰ã™ã‚‹ã“ã¨ã§ç¢ºå®Ÿã«ç‹™ã£ãŸã‚¢ã‚«ã‚¦ãƒ³ãƒˆã¨ãƒªãƒ¼ã‚¸ãƒ§ãƒ³ã«ãƒ‡ãƒ—ãƒ­ã‚¤ã§ãã‚‹

`bin/cdk-demo.ts`

```typescript
const app = new cdk.App();
new CdkDemoStack(app, 'CdkDemoStack', {
  /* If you don't specify 'env', this stack will be environment-agnostic.
   * Account/Region-dependent features and context lookups will not work,
   * but a single synthesized template can be deployed anywhere. */

  /* Uncomment the next line to specialize this stack for the AWS Account
   * and Region that are implied by the current CLI configuration. */
  // env: { account: process.env.CDK_DEFAULT_ACCOUNT, region: process.env.CDK_DEFAULT_REGION },

  /* Uncomment the next line if you know exactly what Account and Region you
   * want to deploy the stack to. */
  env: { account: '123456789012', region: 'us-east-1' }, // ã“ã“

  /* For more information, see https://docs.aws.amazon.com/cdk/latest/guide/environments.html */
});
```

### å®Ÿéš›ã«ã‚¹ã‚¿ãƒƒã‚¯ã‚’å®šç¾©ã—ã¦ã¿ã‚‹

ä»Šå›ã¯ãƒãƒ«ãƒAZã®VPCã‚’ä½œæˆã™ã‚‹ã€‚
`lib/cdk-demo-stack.ts`ã€€ã‚’ä»¥ä¸‹ã®ã‚ˆã†ã«ç·¨é›†

```ts
import * as cdk from "aws-cdk-lib";
import { SubnetType, Vpc } from "aws-cdk-lib/aws-ec2"; // è¿½åŠ 
import { Construct } from "constructs";
// import * as sqs from 'aws-cdk-lib/aws-sqs';

export class CdkDemoStack extends cdk.Stack {
  constructor(scope: Construct, id: string, props?: cdk.StackProps) {
    super(scope, id, props);
    
    // è¿½åŠ ã“ã“ã‹ã‚‰
    const vpc = new Vpc(this, "MainVpc", {
      // CHANGE: this is where we define how many AZs to use
      maxAzs: 2,

      // CHANGE: We define a single subnet configuration per AZ.
      subnetConfiguration: [
        {
          // CHANGE: this is it's CIDR mask so 255.255.255.0
          cidrMask: 24,

          // CHANGE: a name for each of these subnets
          name: "public-subnet",

          // CHANGE: and the subnet type to be used - here we will have
          // a public subnet. There are other options available here.
          subnetType: SubnetType.PUBLIC,
        },
      ],
    });
    
    // è¿½åŠ ã“ã“ã¾ã§
  }
}
```

ã¡ãªã¿ã«ãªãœã‹å…¬å¼ãƒãƒ¥ãƒ¼ãƒˆãƒªã‚¢ãƒ«é€šã‚Šã«ã‚„ã‚‹ã¨ä»¥ä¸‹ã®ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿ

```
å‹ 'this' ã®å¼•æ•°ã‚’å‹ 'Construct' ã®ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ãƒ¼ã«å‰²ã‚Šå½“ã¦ã‚‹ã“ã¨ã¯ã§ãã¾ã›ã‚“ã€‚
```

çµè«–ä»¥ä¸‹ã®æ‰‹é †ã§è§£æ±º

1. node_modulesã¨package-lock.jsonã‚’å‰Šé™¤
2. npm install

ãªã‚“ã‹ãƒãƒ¼ã‚¸ãƒ§ãƒ³é•ã„ã¨ã‹ã§å‹ãŒåˆã‚ãªã‹ã£ãŸæ„Ÿã˜ã‹ãªã¨æ€ã†

### å®Ÿéš›ã«ãƒ‡ãƒ—ãƒ­ã‚¤ã™ã‚‹

ä»¥ä¸‹ã‚³ãƒãƒ³ãƒ‰ã§ãƒ‡ãƒ—ãƒ­ã‚¤ãŒèµ°ã‚‹

```
cdk deploy
```

â†“ã®ã‚ˆã†ãªæ„Ÿã˜ã§ç’°å¢ƒå¤‰æ•°ã‚’æ¸¡ã™ã¨ç’°å¢ƒå¤‰æ•°ã¤ãã§ãƒ‡ãƒ—ãƒ­ã‚¤ã§ãã‚‹(envãƒ•ã‚¡ã‚¤ãƒ«èª­ã‚€æ–¹æ³•ã¯ãªã„ã®ã‹ãªãƒ»ãƒ»ãƒ»)
ã©ã†ã‚„ã‚‰èª¿ã¹ãŸæ„Ÿã˜envãƒ•ã‚¡ã‚¤ãƒ«ã‚’èª­ã‚€ãªã‚‰dotenvã¨ã‹ä½¿ã†ã®ãŒè‰¯ã•ãã†ãªã®ã§ã‚„ã£ã¦ã¿ã‚‹

ãªã‚“ã‹ã„ã‚ã„ã‚ã¤ã¾ã¥ã„ãŸã®ã§ãƒ¡ãƒ¢

â†“ã¿ãŸã„ãªæ„Ÿã˜ã®ã‚¨ãƒ©ãƒ¼ã«ãªã£ãŸ

```
 âŒ Building assets failed: Error: Building Assets Failed: Error: CdkDemoStack: SSM parameter /cdk-bootstrap/hnb659fds/version not found. Has the environment been bootstrapped? Please run 'cdk bootstrap' (see https://docs.aws.amazon.com/cdk/latest/guide/bootstrapping.html)
```

stackåã‚’æŒ‡å®šã™ã‚‹ã¨è§£æ±ºã™ã‚‹ã‚ˆçš„ãªè¨˜äº‹ãŒã¡ã‚‰ã»ã‚‰

https://dailydevsblog.com/troubleshoot/resolved-cdk-deploy-deletes-the-bootstrap-version-ssm-parameter-135956/
https://stackoverflow.com/questions/68643349/cdk-deploy-not-recognizing-my-bootstrap-and-ssm-parameter

çµå±€â†“ã¿ãŸã„ãªæ„Ÿã˜ã§ã‚¢ãƒ—ãƒ­ãƒ¼ãƒã—ãŸã€‚
awsã®credentialã«regionã‚’è¿½åŠ 

`~/.aws/credentials`

```
[default]
aws_access_key_id=
aws_secret_access_key=
region=ap-northeast-1
```

deployã‚³ãƒãƒ³ãƒ‰å®Ÿè¡Œæ™‚ã«profileæƒ…å ±ã‚’æ¸¡ã™

```
cdk deploy --profile default
```

ã“ã‚Œã§ä¸€å¿œãƒ‡ãƒ—ãƒ­ã‚¤ã‚³ãƒãƒ³ãƒ‰ãŒèµ°ã£ãŸã€‚

VPCä½œã‚Šã™ãã§ãƒ‡ãƒ—ãƒ­ã‚¤ã«ã¯å¤±æ•—ã—ãŸã€‚
ã©ã†ã‚„ã‚‰åŒä¸€ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã«ã¤ããƒªãƒ¼ã‚¸ãƒ§ãƒ³ã”ã¨ã«5ã¤ã¾ã§ã—ã‹VPCã¯ã¤ãã‚Œãªã„ã¿ãŸã„ã€‚

æ¬¡ã¯â†“ã®ã‚ˆã†ãªã‚¨ãƒ©ãƒ¼ãŒå‡ºã¦ãƒ‡ãƒ—ãƒ­ã‚¤ã«å¤±æ•—

```
"Value (ap-northeast-1b) for parameter availabilityZone is invalid. Subnets can currently only be created in the following availability zones: ap-northeast-1a, ap-northeast-1c, ap-northeast-1d.
```

ã©ã†ã‚„ã‚‰1bã¯ä½¿ãˆãªã„ãŠã¿ãŸã„ã€‚
`cdk.context.json`ã€€ã‚’ç·¨é›†ã—ã¦ä»¥ä¸‹ã®ã‚ˆã†ã«ã™ã‚‹ã€‚åˆ©ç”¨å¯èƒ½ãªãƒªãƒ¼ã‚¸ãƒ§ãƒ³ã—ã‹ã“ã“ã«ã¯æ›¸ã‹ãªã„ã‚ˆã†ã«ã—ãŸæ–¹ãŒã„ã„ã®ã‹ãªã¨æ€ã†ã€‚

```json
{
  "availability-zones:account=xxxxxxxxxx:region=ap-northeast-1": [
    "ap-northeast-xx",
    "ap-northeast-yy",
    "ap-northeast-zz"
  ]
}
```

ã©ã†ã‚„ã‚‰ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã”ã¨ã«åˆ©ç”¨å¯èƒ½ãªVPCã®AZãŒæ±ºã¾ã£ã¦ã„ã‚‹ã¿ãŸã„ãªã®ã§â†“ã§ç¢ºèªã™ã‚‹

```
aws ec2 describe-availability-zones --region region-name
```

å®Ÿè¡Œçµæœ

```
{
    "AvailabilityZones": [
        {
            "State": "available",
            "OptInStatus": "opt-in-not-required",
            "Messages": [],
            "RegionName": "ap-northeast-1",
            "ZoneName": "ap-northeast-1a",
            "ZoneId": "apne1-az4",
            "GroupName": "ap-northeast-1",
            "NetworkBorderGroup": "ap-northeast-1",
            "ZoneType": "availability-zone"
        },
        {
            "State": "available",
            "OptInStatus": "opt-in-not-required",
            "Messages": [],
            "RegionName": "ap-northeast-1",
            "ZoneName": "ap-northeast-1c",
            "ZoneId": "apne1-az1",
            "GroupName": "ap-northeast-1",
            "NetworkBorderGroup": "ap-northeast-1",
            "ZoneType": "availability-zone"
        },
        {
            "State": "available",
            "OptInStatus": "opt-in-not-required",
            "Messages": [],
            "RegionName": "ap-northeast-1",
            "ZoneName": "ap-northeast-1d",
            "ZoneId": "apne1-az2",
            "GroupName": "ap-northeast-1",
            "NetworkBorderGroup": "ap-northeast-1",
            "ZoneType": "availability-zone"
        }
    ]
}
```

ã“ã‚Œã§a, c, dã—ã‹ä½¿ãˆãªã„ã“ã¨ãŒã‚ã‹ã‚‹ã€‚

å®Ÿéš›ã«a, c, dã«åˆ¶é™ã™ã‚‹ã¨ç„¡äº‹ãƒ‡ãƒ—ãƒ­ã‚¤æˆåŠŸã€‚ã‚„ã£ãŸã€‚

```
cdk deploy --profile default

âœ¨  Synthesis time: 13.89s

CdkDemoStack: building assets...

[0%] start: Building 26740e2f73367d0de7f47969183fdb0382e45092f633de32edd12dccfbb6caac:957017051518-ap-northeast-1
[100%] success: Built 26740e2f73367d0de7f47969183fdb0382e45092f633de32edd12dccfbb6caac:957017051518-ap-northeast-1

CdkDemoStack: assets built

CdkDemoStack: deploying...
[0%] start: Publishing 26740e2f73367d0de7f47969183fdb0382e45092f633de32edd12dccfbb6caac:957017051518-ap-northeast-1
[100%] success: Published 26740e2f73367d0de7f47969183fdb0382e45092f633de32edd12dccfbb6caac:957017051518-ap-northeast-1
CdkDemoStack: creating CloudFormation changeset...

 âœ…  CdkDemoStack

âœ¨  Deployment time: 76.4s

Stack ARN:
arn:aws:cloudformation:ap-northeast-1:957017051518:stack/CdkDemoStack/8fde7270-5268-11ed-ac0f-06cfd0397ec7

âœ¨  Total time: 90.29s
```

AWSã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã‹ã‚‰å®Ÿéš›ã«VPCã‚’ç¢ºèªã§ããŸ

æ¬¡ã¯ã“ã®VPCã«Ec2ã§ã‚‚ç«‹ã¦ã¦ã¿ã‚ˆã†